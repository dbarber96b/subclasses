/*	-WHAT IS THIS?-
	This file adds optional material to "MPMB's Character Record Sheet" found at https://flapkan.com/mpmb/charsheets
	Import this file using the "Add Extra Materials" bookmark.

	-KEEP IN MIND-
	It is recommended to enter the code in a fresh sheet before adding any other information (i.e. before making your character with it).
*/

/*	-INFORMATION-
	Subject:	Subclass
	Effect:		This script adds a subclass for the Warlock, called "Lady of the Lake"
				
	Code by:	dbarber96b
	Date:		2021-07-21 (sheet v13.0.0beta16)
*/

var iFileName = "Romythra.js";
RequiredSheetVersion(13);

SourceList["GMBDB"] = {
	name : "GMBinderDBarber96b",
	abbreviation : ["GMBDB"],
	group : "Dbarber96b",
	url : "https://www.gmbinder.com/share/-MezALlhpv89Ezt1QQlz",
	date : "2021/07/21"
};
AddSubClass("warlock", "the lady of the lake", {
	regExpSearch : /^(?=.*warlock)(?=.*lady)(?=.*(lake)).*$/i,
	subname : "the Lady of the Lake",
	source : ["GMBDB"],
	spellcastingExtra : ["shield", "bane", "calm emotions", "find steed", "crusader's mantle", "elemental weapon", "aura of purity", "control water", "dispel evil and good", "holy weapon"],
	features : {
		"subclassfeature1" : {
			name : "Warrior's Challenge",
			source : ["GMBDB"],
			minlevel : 1,
			description : desc([
				"As a bonus action, I can challenge a creature I can see within 30 ft of me for 1 minute",
				"\u2022 I add my proficiency bonus to damage rolls against the challenged target",
				"\u2022 My attack rolls against the challenged target score a critical hit on a roll of 19 and 20",
				"\u2022 If the target attacks a creature other than me, it must make a Wisdom saving throw or else make the attack at disadvantage",
				"The challenge ends after 1 minute, when the target dies, I die, or I'm incapacitated"
			]),
			recovery : "short rest",
			usages : 1,
			action : ["bonus action", ""],
			calcChanges : {
				atkAdd : [
					function (fields, v) {
						if (!v.isDC && (/challenge/i).test(v.WeaponText) && !v.CritChance) {
							v.CritChance = 19;
							fields.Description += (fields.Description ? '; ' : '') + 'Crit on 19-20';
						}
					},
					"If I include the word 'Challenge' in the name of a weapon, the automation will treat the attack as being against a target of the Warrior's Challenge: adding my proficiency bonus to the damage and adding the increased chance of a critical hit to the description."
				],
				atkCalc : [
					function (fields, v, output) {
						if ((/challenge/i).test(v.WeaponText)) output.extraDmg += output.prof;
					}, ""]
			}
		},
		"subclassfeature1.1" : {
			name : "Sentinel",
			source : ["GMBDB"],
			minlevel : 1,
			description : desc([
				"I gain proficiency with medium armor, shields, and martial weapons",
				"When I finish a long rest, I can imbue one weapon I touch with my will",
				"Until my next long rest, I can use it with Charisma instead of Strength or Dexterity",
				"I have to be proficient with the weapon and it can't have the two-handed property",
				"This benefit also works with every weapon from Pact of the Blade, with no restriction",
                "For my eldritch blast, I can change the damage type to radiant"
			]),
			armorProfs : [false, true, false, true],
			weaponProfs : [false, true],
			calcChanges : {
				atkAdd : [
					function (fields, v) {
						var hasPactWeapon = GetFeatureChoice('class', 'warlock', 'pact boon') == 'pact of the blade';
						if (What('Cha Mod') > What(AbilityScores.abbreviations[fields.Mod - 1] + ' Mod') && (v.pactWeapon || v.theWea.pactWeapon || (hasPactWeapon && (/\bpact\b/i).test(v.WeaponText)) || (/^(?=.*hexblade)(?!.*((^|[^+-]\b)2|\btwo).?hand(ed)?s?\b).*$/i).test(v.WeaponText))) {
							fields.Mod = 6;
						};
					},
					"If I include the word 'Sentinel' in the name of a weapon that is not two-handed, it gets treated as the weapon I imbued to use Charisma instead of Strength or Dexterity, if my Charisma modifier is higher than the ability it would otherwise use. Alternatively, if I have the Pact of the Blade feature, this will also work if I include 'Pact' in the name of a weapon, regardless if it has the two-handed property."
				]
			}
		},
		"subclassfeature6" : {
			name : "Enchanted Blade",
			source : ["GMBDB"],
			minlevel : 6,
			description : desc([
				"I can choose a spell of 5th level or lower that I can cast, which targets one or more creatures, and which requires them to make a saving throw",
				"If channeling my will through a melee weapon using the Sentinel feature, I can enchant the blade with the spell instead of casting it, using the same components",
				"The enchantment has a number of charges equal to the number of targets allowed by the spell, and its duration, equal to that of the spell, begins when placed on the weapon",
				"When I hit a creature with a weapon attack using this weapon, I can expend a charge of the spell, the target makes the saving throw at disadvantage.",
				]),
			usages : "Charisma modifier per ",
      usagescalc : "event.value = Math.max(1, What('Cha Mod'));",
			recovery : "long rest",
		},
    "subclassfeature10" : {
			name : "Armor of the Chalice",
			source : ["GMBDB"],
			minlevel : 10,
			description : desc([
				"As a reaction when a Warrior's Challenge recipient hits me with an attack, I can roll a d6",
				"On a result of 4 or higher, the attacks misses me instead, regardless of its d20 roll"
			])
		},
		"subclassfeature14" : {
			name : "Champion of the Grail",
			source : ["GMBDB"],
			minlevel : 14,
			description : desc([
				"When the target of my Warrior's Challenge dies, I can challenge another I can see within 30 ft",
				"I can't do this while incapacitated and I don't regain HP from the death of the previous"
			])
		}
	}
});

AddSubClass("cleric", "avalon domain", {
	regExpSearch : /^(?=.*(cleric|priest|clergy|acolyte))(?=.*(avalon|knight|lake)).*$/i,
	subname : "Avalon Domain",
	source : ["GMBDB"],
	spellcastingExtra : ["divine favor", "sanctuary", "gentle repose", "spiritual weapon", "beacon of hope", "blinding smite", "control water", "guardian of faith", "mass cure wounds", "banishing smite"],
	features : {
		"subclassfeature1" : {
			name : "Bonus Proficiency",
			source : ["GMBDB"],
			minlevel : 1,
			description : "\n   " + "I gain proficiency with martial weapons and heavy armor",
			armorProfs : [false, false, true, false],
			weaponProfs : [false, true]
      },
		"subclassfeature1.1" : {
			name : "Divine Knight",
			source : ["GMBDB"],
			minlevel : 1,
			description : "\n   " + "When I use the Attack action, I can make a weapon attack as a bonus action",
			usages : "Wisdom modifier per ",
			usagescalc : "event.value = Math.max(1, What('Wis Mod'));",
			recovery : "long rest",
			action : ["bonus action", " (with Attack action)"]
		},
		"subclassfeature2" : {
			name : "Channel Divinity: Waters of the Grail",
			source : ["GMBDB"],
			minlevel : 2,
			description : "\n   " + "I can bless pure fresh water for healing purposes" + "\n   " + "The water must be stored in a water skin or other appropriate vessel" + "\n   " + "The water instantly restores 10 hp when consumed" + "\n   " + "The water loses the magical benefits after 48 hours, and cannot be re-blessed",
			usages : "Wisdom modifier per ",
			usagescalc : "event.value = Math.max(1, What('Wis Mod'));",
		},
		"subclassfeature6" : {
			name : "Channel Divinity: Blessing of the Mists",
			source : ["GMBDB"],
			minlevel : 6,
			description : "\n   " + "As a reaction, when I or an ally I see with 30 ft fails a saving throw, I can cause myself or my ally to reroll the saving throw " + "\n   " + "A creature that succeeds a saving throw using this ability regains hit points equal to my cleric level",
			usages : "Wisdom modifier per ",
			usagescalc : "event.value = Math.max(1, What('Wis Mod'));",
            action : ["reaction", ""]
		},
		"subclassfeature8" : {
			name : "Divine Justice",
			source : ["GMBDB"],
			minlevel : 8,
			description : "\n   " + "Once per turn, when I hit a creature with a weapon attack, I can do extra damage",
			additional : levels.map(function (n) {
				if (n < 8) return "";
				return "+" + (n < 14 ? 1 : 2) + "d8 radiant damage";
			}),
			calcChanges : {
				atkAdd : [
					function (fields, v) {
						if (classes.known.cleric && classes.known.cleric.level > 7 && !v.isSpell) {
							fields.Description += (fields.Description ? '; ' : '') + 'Once per turn +' + (classes.known.cleric.level < 14 ? 1 : 2) + 'd8 radiant damage';
						}
					},
					"Once per turn, I can have one of my weapon attacks that hit do extra radiant damage."
				]
			}
		},
		"subclassfeature17" : {
			name : "Prayer for the Fallen Warrior",
			source : ["GMBDB"],
			minlevel : 17,
			description : "\n   " + "As a reaction once per day, when an ally with 30 ft. is reduced to 0 or fewer hp, I can renew their spirit to fight on" + "\n   " + "The target regains half their hit points, and can stand as a free action" + "\n   " + "On my ally's next action, they have advantage on attack rolls",
        usages : 1,
        action : ["reaction", ""]
		}
	}
});

AddSubClass("paladin", "oath of the lake", {
	regExpSearch : /^((?=.*(knight|lake))|((?=.*(nimue|arthurian))(((?=.*paladin)|((?=.*(exalted|sacred|holy|divine))(?=.*(knight|fighter|warrior|warlord|trooper))))))).*$/i,
	subname : "Oath of the Lake",
	source : ["GMBDB"],
	features : {
		"subclassfeature3" : {
			name : "Channel Divinity: Sacrifice for the Lady",
			source : ["GMBDB"],
			minlevel : 3,
			description : "\n   " + "I can use my channel divinity to grant myself advantage on melee attacks on my next turn" + "\n   " + "The target also gets advantage on attacks against me on its turn",
			spellcastingExtra : ["heroism", "compelled duel", "misty step", "enhance ability", "bestow curse", "crusader's mantle", "spirit guardians", "aura of purity", "guardian of faith", "circle of power", "dispel good and evil"]
		},
		"subclassfeature3.1" : {
			name : "Channel Divinity: Anvil and Hammer",
			source : ["UA:PSO", 1],
			minlevel : 3,
			description : "\n   " + "As a reaction, I can use my channel divinity to intercept an attack on a friendly creature" + "\n   " + "The creature must be within a radius of my movement" + "\n   " + "The attacker must now target me instead of my ally" + "\n   " + "I can make a melee attack if the attacker is in range, even if the triggering attack would drop me",
      action : ["reaction", ""]
      },
		"subclassfeature7" : {
			name : "Mighty Deed",
			source : ["GMBDB"],
			minlevel : 7,
			description : desc([
				"When I score a critical hit or reduce a target to 0 HP, I can bolster morale or demoralize",
				"Up to my Cha mod (min 1) of creatures I can see in 30 ft suffer the same chosen effect:",
				" \u2022 All creatures gain temp HP equal to 1d6 + my Charisma modifier (min 1 temp HP)",
				" \u2022 All creatures must make a Wis save or be frightened of me until my next turn starts"
			]),
			recovery : "Round",
			usages : 1
		},
		"subclassfeature15" : {
			name : "Sword of the Lady",
			source : ["GMBDB"],
			minlevel : 15,
			description : "\n   " + "I am compelled to travel to the nearest body of pure water" + "\n   " + "After 24 hours of prayer and fasting, the Lady of the Lake appears and gifts a sacred sword" + "\n   " + "The Sword requires attunement and being given a name to unlock all its benfits" + "\n   " + "My DM will decide the sword's attributes."
		},
		"subclassfeature20" : {
			name : "Champion of the Court",
			source : ["UA:PSO", 2],
			minlevel : 20,
			description : "\n   " + "As an action, I can gain the following benefits for 1 hour:" + "\n    - " + "I have resistance to bludgeoning, piercing, and slashing damage from nonmagical weapons" + "\n    - " + "My allies have advantage on Death Saving throws while within 30 feet of me" + "\n    - " + "I gain the benefits of the Enlarge Spell" + "\n    - " + "Attacks on me, and friendly creatures within a 30-foot radius, are made with disadvantage",
			recovery : "long rest",
			usages : 1,
			action : ["action", ""]
		}
	}
});
AddSubClass("fighter", "green-knight", {
	regExpSearch : /^(?=.*arcane)(?=.*archer).*$/i,
	subname : "Green Knight",
	source : ["GMBDB"],
	fullname : "Green Knight",
	abilitySave : 4,
	features : {
		"subclassfeature3" : {
			name : "Aspects of the Vale",
			source : ["X", 28],
			minlevel : 3,
			description : desc([
				"I gain proficiency with the Persuasion and Perception skills",
				"I also learn the Druidcraft cantrip"
			]),
			skillstxt : "Persuasion and Perception",
			spellcastingBonus : {
				name : "Aspects of the Vale",
				spells : ["druidcraft"]
			},
		},
    "subclassfeature7" : {
			name : "Rooted in Mortality",
			source : ["GMBDB"],
			minlevel : 7,
			description : "\n   " + "I become proficient in Death saving throws" + "If the result of the saving throw is 20 or higher, I regain 1 hit point"
		},
    "subclassfeature10" : {
			name : "Companion of Vines",
			source : ["GMBDB"],
			minlevel : 10,
			description : desc([
				"As a bonus action I can summon an illusion wrapped in vines and dense leaves",
				"The illusion appears in a space adjeacent to a target of my attack, and makes an attack with a mundane copy of my weapon",
        "This illusion can make opportunity attacks as if you were in the place of the copy",
        "The illusion cannont move from the location it appeared in, and lasts for 1 minute"
			]),
			usages : "Charisma modifier per ",
      usagescalc : "event.value = Math.max(1, What('Cha Mod'));",
			recovery : "long rest",
			action : ["bonus action", ""]
		},
    "subclassfeature15" : {
			name : "Against the Odds",
			source : ["GMBDB"],
			minlevel : 15,
			description : "\n   " + "When I use Action Surge on my turn, I gain a number of temporary hit points equalt to my Constitution modifier for each hostile creature within 10 feet of me"
		},
		"subclassfeature18" : {
			name : "Undaunted Form",
			source : ["GMBDB"],
			minlevel : 18,
      recovery : "long rest",
			description : desc([
				"I will a physical copy of myself into existence in a space within 5 feet of me",
				"When it appears, it makes a melee weapon attack against a hostile creature within range",
				"The copy has a number of hit points equal to half of my total hit points",
        "It lasts for eight hours, until it is reduced to 0 hit points, or until it is dismissed as an action",
        "The copy shares my initiative, has mundane copies of the weapons I have, which it can make an attack with as an action",
        "The copy's attacks count as magical for overcoming resistances and immunities, and has an attack bonus equal to my Charisma + my proficiency bonus. On a hit it deals 2d8 + my Charisma modifier force damage",
        "The copy follows my commands, which I communicate telepathically",
			])
		}
	}
});
AddSubClass("sorcerer", "myrddins legacy", {
	regExpSearch : /^(?=.*myrddin)(?=.*legacy)(?=.*(fey)).*$/i,
	subname : "Myrddin's Legacy",
	source : ["GMBDB"],
	spellcastingExtra : ["shield", "bane", "calm emotions", "find steed", "crusader's mantle", "elemental weapon", "aura of purity", "control water", "dispel evil and good", "holy weapon"],
	features : {
		"subclassfeature1" : {
			name : "Mask of the Courts",
			source : ["GMBDB"],
			minlevel : 1,
			description : desc([
				"I can cast disguise self at will without using a spell slot",
				"This spell counts as a sorcerer spell for me, but doesn't count against my number of spells known"
			]),
			spellcastingBonus : {
				name : "Mask of the Courts",
				spells : ["disguise self"],
				selection : ["disguise self"]
			}
		},
		"subclassfeature3" : {
			name : "Aspects of the Vale",
			source : ["GMBDB"],
			minlevel : 3,
			description : desc([
				"I gain proficiency with the Insight skill",
				"I also have advantage on Wisdom (Insight) checks when determining a creature's emotional state",
                "I can't be put to sleep by magic, and I have advantage on saves against the effect of the calm emotions spell",
                "I can speak, read, and write Sylvan, and I can use a druidic focus as my spell casting focus"
			]),
			skillstxt : "Insight",
      languageProfs : ["Sylvan"],
      savetxt : { immune : ["calm emotions"] },
		adv_vs : ["charmed"]
    },
		"subclassfeature6" : {
			name : "A Wink and a Nod",
			source : ["GMBDB"],
			minlevel : 6,
            action : ["bonus action", ""],
			description : " [2 sorcery points]" + desc([
				"By spending 2 sorcery points, I can turn invisible and magically teleport up to 30 feet to an unoccupied space that I can see",
				"I remain invisible until the start of my next turn, or until I attack or cast a spell"
			])
      
		},
		"subclassfeature14" : {
			name : "Travel the Realms",
			source : ["GMBDB"],
			minlevel : 14,
			description : desc([
				"I can learn the teleport spell if I don't already know it",
				"This spell doesn't count against my number of spells known",
        
			]),
			spellcastingBonus : {
				name : "Travel the Realms",
				spells : ["teleport"],
				selection : ["teleport"]
			}
		},
		"subclassfeature18" : {
			name : "Myrddin's Inheritance",
			source : ["GMBDB"],
			minlevel : 18,
      usages : "Charisma modifier per ",
			usagescalc : "event.value = Math.max(1, What('Cha Mod'));",
			recovery : "long rest",
			description : "\n   " + "I become immune to all effects that charm, frighten, or put me to sleep" + "\n   " + "I can extend an 30 foot aura. All creatures of the humanoid or beast type must succeed a Charisma saving throw when they start their turn in the aura or be charmed" + "\n   " + "I can spend 5 sorcery points to give all creatures disadvantage on this save",
			action : ["bonus action"],
			savetxt : { immune : ["charmed", "sleep", "frightened"] }
		}
	}
});
