/*	-WHAT IS THIS?-
	This file adds optional material to "MPMB's Character Record Sheet" found at https://flapkan.com/mpmb/charsheets
	Import this file using the "Add Extra Materials" bookmark.

	-KEEP IN MIND-
	It is recommended to enter the code in a fresh sheet before adding any other information (i.e. before making your character with it).
*/

/*	-INFORMATION-
	Subject:	Subclass
	Effect:		This script adds a subclass for the Warlock, called "Lady of the Lake"
				
	Code by:	dbarber96b
	Date:		2021-07-21 (sheet v13.0.0beta16)
*/

var iFileName = "LadyoftheLake.js";
RequiredSheetVersion(13);

SourceList["GMBDB"] = {
	name : "GMBinderDBarber96b",
	abbreviation : ["GMBDB"],
	group : "Dbarber96b",
	url : "https://www.gmbinder.com/share/-MezALlhpv89Ezt1QQlz",
	date : "2021/07/21"
};
AddSubClass("warlock", "Lady of the Lake",) {
	regExpSearch : /^(?=.*ladyofthelake)(?=.*warlock).*$/i,
	subname : "Lady of the Lake",
	source : ["GMBDB"],
	spellcastingExtra : ["shield", "bane", "calm emotions", "find steed", "crusader's mantle", "elemental weapon", "aura of purity", "control water", "dispel evil and good", "holy weapon"],
	features : {
		"subclassfeature1" : {
			name : "Warrior's Challenge",
			source : ["GMBDB"],
			minlevel : 1,
			description : desc([
				"As a bonus action, I can challenge a creature I can see within 30 ft of me for 1 minute",
				"\u2022 I add my proficiency bonus to damage rolls against the challenged target",
				"\u2022 My attack rolls against the challenged target score a critical hit on a roll of 19 and 20",
				"\u2022 If the target attacks a creature other than me, it must make a Wisdom saving throw or else make the attack at disadvantage",
				"The curse ends after 1 minute, when the target dies, I die, or I'm incapacitated"
			]),
			recovery : "short rest",
			usages : 1,
			action : ["bonus action", ""],
			calcChanges : {
				atkAdd : [
					function (fields, v) {
						if (!v.isDC && (/challenge/i).test(v.WeaponText) && !v.CritChance) {
							v.CritChance = 19;
							fields.Description += (fields.Description ? '; ' : '') + 'Crit on 19-20';
						}
					},
					"If I include the word 'Challenge' in the name of a weapon, the automation will treat the attack as being against a target of the Warrior's Challenge: adding my proficiency bonus to the damage and adding the increased chance of a critical hit to the description."
				],
				atkCalc : [
					function (fields, v, output) {
						if ((/challenge/i).test(v.WeaponText)) output.extraDmg += output.prof;
					}, ""]
			}
		},
		"subclassfeature1.1" : {
			name : "Sentinel",
			source : ["GMBDB"],
			minlevel : 1,
			description : desc([
				"I gain proficiency with medium armor, shields, and martial weapons",
				"When I finish a long rest, I can imbue one weapon I touch with my will",
				"Until my next long rest, I can use it with Charisma instead of Strength or Dexterity",
				"I have to be proficient with the weapon and it can't have the two-handed property",
				"This benefit also works with every weapon from Pact of the Blade, with no restriction",
                "For my eldritch blast, I can change the damage type to radiant"
			]),
			armorProfs : [false, true, false, true],
			weaponProfs : [false, true],
			calcChanges : {
				atkAdd : [
					function (fields, v) {
						var hasPactWeapon = GetFeatureChoice('class', 'warlock', 'pact boon') == 'pact of the blade';
						if (What('Cha Mod') > What(AbilityScores.abbreviations[fields.Mod - 1] + ' Mod') && (v.pactWeapon || v.theWea.pactWeapon || (hasPactWeapon && (/\bpact\b/i).test(v.WeaponText)) || (/^(?=.*hexblade)(?!.*((^|[^+-]\b)2|\btwo).?hand(ed)?s?\b).*$/i).test(v.WeaponText))) {
							fields.Mod = 6;
						};
					},
					"If I include the word 'Sentinel' in the name of a weapon that is not two-handed, it gets treated as the weapon I imbued to use Charisma instead of Strength or Dexterity, if my Charisma modifier is higher than the ability it would otherwise use. Alternatively, if I have the Pact of the Blade feature, this will also work if I include 'Pact' in the name of a weapon, regardless if it has the two-handed property."
				]
			}
		},
		"subclassfeature6" : {
			name : "Enchanted Blade",
			source : ["GMBDB"],
			minlevel : 6,
			description : desc([
				"I can choose a spell of 5th level or lower that I can cast, which targets one or more creatures, and which requires them to make a saving throw",
				"If channeling my will through a melee weapon using the Sentinel feature, I can enchant the blade with the spell instead of casting it, using the same components",
				"The enchantment has a number of charges equal to the number of targets allowed by the spell, and its duration, equal to that of the spell, begins when placed on the weapon",
				"When I hit a creature with a weapon attack using this weapon, I can expend a charge of the spell, the target makes the saving throw at disadvantage.",
				]),
			usages : "Charisma modifier per ",
      usagescalc : "event.value = Math.max(1, What('Cha Mod'));",
			recovery : "long rest",
		},
    "subclassfeature10" : {
			name : "Armor of the Chalice",
			source : ["GMBDB"],
			minlevel : 10,
			description : desc([
				"As a reaction when a Warrior's Challenge recipient hits me with an attack, I can roll a d6",
				"On a result of 4 or higher, the attacks misses me instead, regardless of its d20 roll"
			])
		},
		"subclassfeature14" : {
			name : "Champion of the Grail",
			source : ["GMBDB"],
			minlevel : 14,
			description : desc([
				"When the target of my Warrior's Challenge dies, I can challenge another I can see within 30 ft",
				"I can't do this while incapacitated and I don't regain HP from the death of the previous"
			])
		}
	}
});
